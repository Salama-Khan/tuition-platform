<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Student Tasks</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6">
  <h1 class="text-2xl font-semibold mb-4">My Tasks</h1>

  <ul class="space-y-3">
    {% for t in tasks %}
      <li class="border rounded p-3">
        <div class="flex justify-between items-center">
          <div class="font-medium">
            {{ t.title }} — {{ t.subject.name }} ({{ t.teacher.username }})
          </div>
          {% if t.id in submitted_task_ids %}
            <span class="ml-2 px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">submitted</span>
          {% endif %}
          {% if t.id in locked_task_ids %}
            <span class="ml-2 px-2 py-1 text-xs rounded bg-gray-200 text-gray-800">locked</span>
          {% endif %}
        </div>

        <div class="text-sm text-gray-600">Due: {{ t.due_dt|default:"-" }}</div>

        {% for task_id, latest in latest_by_task.items %}
          {% if task_id == t.id %}
            <div class="mt-2 text-sm">
              {% if latest.feedback_text %}
                <div class="p-2 rounded bg-green-50 border border-green-200">
                  <div class="text-xs font-medium text-green-800">Teacher feedback:</div>
                  <div class="text-sm text-green-900 whitespace-pre-line">{{ latest.feedback_text }}</div>
                  {% if latest.feedback_at %}
                    <div class="text-xs text-green-700 mt-1">on {{ latest.feedback_at }}</div>
                  {% endif %}
                </div>
              {% else %}
                <div class="mt-1 text-xs text-gray-600">No feedback yet.</div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}

        <div class="mt-2">
          {% if t.id in locked_task_ids %}
            <span class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-800">Locked — no more submissions</span>
          {% else %}
            <a class="text-sm underline" href="{% url 'student_submit' t.id %}">Submit / Resubmit</a>
          {% endif %}

          {% for task_id, latest in latest_by_task.items %}
            {% if task_id == t.id and latest.file_url %}
              <a class="ml-3 text-sm underline" href="{{ latest.file_url }}" target="_blank" rel="noopener">
                View last file
              </a>
            {% endif %}
          {% endfor %}
        </div>
      </li>
    {% empty %}
      <li class="text-sm text-gray-600">No tasks yet.</li>
    {% endfor %}
  </ul>
</body>
</html>
